# Branch: 4-17-SQL

## ğŸ“‹ InformaÈ›ii Generale
- **Status**: âœ… MERGED (PR #5)
- **Bazat pe**: 4-15-postgresql (dupÄƒ merge Ã®n master)
- **Commits**: 2
- **FiÈ™iere modificate**: 6
- **Linii de cod**: +34, -11 (net: +23)
- **Data merge**: 1 Octombrie 2025

## ğŸ¯ Scopul Branch-ului

Acest branch marcheazÄƒ **trecerea completÄƒ de la H2 (in-memory database) la PostgreSQL** È™i introduce **prima migrare Flyway** cu schema realÄƒ de baze de date. Este primul branch care creeazÄƒ o structurÄƒ persistentÄƒ de date Ã®n aplicaÈ›ie.

### MotivaÈ›ie
- **Eliminarea H2 database** - Ã®nlocuire cu PostgreSQL pentru persistenÈ›Äƒ realÄƒ
- **Prima migrare Flyway** - crearea tabelului `posts` cu schema completÄƒ
- **Seed data** - popularea iniÈ›ialÄƒ a bazei de date cu posturi de test
- **IntelliJ database integration** - configurarea IDE pentru lucrul cu PostgreSQL

## âœ¨ ModificÄƒri Implementate

### 1. Eliminarea H2 Database
**FiÈ™ier**: `iam_Service/pom.xml`

```xml
<!-- ÃNAINTE - H2 dependency eliminatÄƒ -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

**MotivaÈ›ie eliminare:**
- H2 este in-memory - datele se pierd la restart
- Nu reflectÄƒ comportamentul production (care va folosi PostgreSQL)
- Nu permite testarea feature-urilor PostgreSQL specifice
- ComplicaÈ›ii cu Flyway migrations pentru multiple dialecte SQL

### 2. Configurare PostgreSQL È™i Flyway
**FiÈ™ier**: `iam_Service/src/main/resources/application-local-idea.properties`

```properties
# Database Configuration
spring.datasource.url=jdbc:postgresql://localhost:5432/post_hub_local
spring.datasource.username=postgres
spring.datasource.password=postgresql
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate Configuration
spring.jpa.properties.hibernate.default_schema=v1_iam_service
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update

# Flyway Configuration
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.schemas=v1_iam_service

# Logging
logging.level.org.flywaydb=DEBUG
```

**ConfiguraÈ›ii cheie:**
- **Database**: `post_hub_local` pe localhost:5432
- **Schema**: `v1_iam_service` - permite versioning È™i multi-schema support
- **Flyway**: migrations Ã®n `classpath:db/migration`
- **Hibernate ddl-auto**: `update` - sincronizeazÄƒ entitÄƒÈ›ile cu schema DB

### 3. Prima Migrare Flyway - V1__init.sql
**FiÈ™ier**: `iam_Service/src/main/resources/db/migration/V1__init.sql`

```sql
CREATE TABLE posts(
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255),
    content TEXT,
    created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    likes INTEGER NOT NULL DEFAULT 0,
    Unique(title)
);

INSERT INTO posts(title, content, created, likes) VALUES (
    'First post',
    'This is the first post',
    CURRENT_TIMESTAMP,
    9
),
(
    'Second post',
    'This is the second post',
    CURRENT_TIMESTAMP,
    20
);
```

**Schema `posts` table:**
| ColoanÄƒ | Tip | Constraints | Default | Scop |
|---------|-----|-------------|---------|------|
| `id` | BIGSERIAL | PRIMARY KEY | Auto-increment | Identificator unic |
| `title` | VARCHAR(255) | UNIQUE | - | Titlul postului (unic) |
| `content` | TEXT | - | - | ConÈ›inutul postului (nelimitat) |
| `created` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Data/ora creÄƒrii |
| `likes` | INTEGER | NOT NULL | 0 | NumÄƒr de aprecieri |

**Seed Data:**
- 2 posturi de test pre-populate database-ul
- Permite testare imediatÄƒ a API-urilor
- Date realiste pentru development

### 4. IntelliJ IDEA Database Integration
**FiÈ™iere**: `.idea/data_source_mapping.xml`, `.idea/sqldialects.xml`

**data_source_mapping.xml**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="DataSourcePerFileMappings">
    <file url="file://$PROJECT_DIR$/iam_Service/src/main/resources/db/migration/V1__init.sql"
          value="448f90c0-e103-4844-9353-70624fdfddf9" />
  </component>
</project>
```

**sqldialects.xml**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="SqlDialectMappings">
    <file url="file://$PROJECT_DIR$/iam_Service/src/main/resources/db/migration/V1__init.sql"
          dialect="PostgreSQL" />
  </component>
</project>
```

**Beneficii:**
- SQL autocompletion Ã®n IntelliJ
- Syntax highlighting specific PostgreSQL
- Database console integration
- Schema visualization tools

## ğŸ”§ Implementare TehnicÄƒ DetaliatÄƒ

### ArhitecturÄƒ È™i Pattern-uri

#### 1. Flyway Database Migrations

**Ce este Flyway?**
Flyway este un tool de version control pentru baze de date care permite:
- MigrÄƒri versionate (`V1__`, `V2__`, etc.)
- Rollback capabilities (prin migrÄƒri reverse)
- Tracking al versiunii schema Ã®n `flyway_schema_history` table
- MigrÄƒri repetabile È™i idempotente

**Naming Convention:**
```
V{VERSION}__{DESCRIPTION}.sql

V1__init.sql                    âœ… Valid
V2__add_users_table.sql         âœ… Valid
V1.1__hotfix_posts.sql          âœ… Valid
init.sql                        âŒ Invalid (lipseÈ™te V È™i versiune)
V1_init.sql                     âŒ Invalid (doar un underscore)
```

**Cum funcÈ›ioneazÄƒ:**
1. La startup, Flyway scaneazÄƒ `classpath:db/migration`
2. VerificÄƒ `flyway_schema_history` pentru migrÄƒri deja aplicate
3. AplicÄƒ doar migrÄƒrile noi (versiune mai mare)
4. ÃnregistreazÄƒ fiecare migrare cu checksum pentru detectare modificÄƒri

**Exemplu flyway_schema_history:**
```sql
SELECT * FROM flyway_schema_history;

| installed_rank | version | description | type | script          | checksum    | installed_on        | success |
|----------------|---------|-------------|------|-----------------|-------------|---------------------|---------|
| 1              | 1       | init        | SQL  | V1__init.sql    | -1234567890 | 2025-10-01 22:23:15 | TRUE    |
```

**Best Practices Flyway:**
- âœ… **NICIODATÄ‚** nu modifica migrÄƒri deja aplicate (checksum va diferi)
- âœ… CreeazÄƒ migrare nouÄƒ pentru orice modificare (V2, V3, etc.)
- âœ… TesteazÄƒ migrÄƒrile pe DB local Ã®nainte de production
- âœ… FoloseÈ™te transactions pentru migrÄƒri atomice
- âœ… Include rollback scripts cÃ¢nd e posibil

#### 2. PostgreSQL BIGSERIAL vs SERIAL

**BIGSERIAL** (folosit pentru `id` column):
```sql
id BIGSERIAL PRIMARY KEY
```

**Ce face BIGSERIAL:**
```sql
-- Este echivalent cu:
CREATE SEQUENCE posts_id_seq;

CREATE TABLE posts(
    id BIGINT NOT NULL DEFAULT nextval('posts_id_seq'),
    ...
    PRIMARY KEY(id)
);

ALTER SEQUENCE posts_id_seq OWNED BY posts.id;
```

**SERIAL vs BIGSERIAL:**
| Type | Range | Storage | Use Case |
|------|-------|---------|----------|
| **SERIAL** | 1 to 2,147,483,647 | 4 bytes | Tabele mici/medii |
| **BIGSERIAL** | 1 to 9,223,372,036,854,775,807 | 8 bytes | Tabele mari (future-proof) |

**De ce BIGSERIAL pentru posts:**
- âœ… **Future-proof** - 9 quintilioane de posturi posibile
- âœ… **Best practice** - pentru tabele care pot creÈ™te semnificativ
- âœ… **Standard modern** - majoritatea aplicaÈ›iilor moderne folosesc BIGINT pentru IDs

#### 3. PostgreSQL Data Types Alese

**VARCHAR(255) vs TEXT:**
```sql
title VARCHAR(255)      -- Lungime limitatÄƒ, indexable eficient
content TEXT            -- Lungime nelimitatÄƒ, pentru conÈ›inut mare
```

**De ce VARCHAR(255) pentru title:**
- âœ… LimiteazÄƒ lungimea titlului (UI/UX best practice)
- âœ… PerformanÈ›Äƒ mai bunÄƒ pentru indexing (UNIQUE constraint)
- âœ… Storage optimization pentru coloane frecvent cÄƒutate

**De ce TEXT pentru content:**
- âœ… SuportÄƒ conÈ›inut lung (articole, blog posts)
- âœ… FÄƒrÄƒ limitÄƒ de caractere
- âœ… PostgreSQL optimizeazÄƒ automat storage pentru TEXT

**TIMESTAMP vs TIMESTAMPTZ:**
```sql
created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
```

âš ï¸ **ObservaÈ›ie**: FoloseÈ™te `TIMESTAMP` fÄƒrÄƒ timezone
- Ãn production, **TIMESTAMPTZ** (cu timezone) este mai recomandat
- Permite storage UTC È™i conversie la timezone local
- EvitÄƒ probleme cu DST (Daylight Saving Time)

**Ar trebui:**
```sql
created TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
```

#### 4. Constraints È™i ValidÄƒri

**PRIMARY KEY:**
```sql
id BIGSERIAL PRIMARY KEY
```
- GaranteazÄƒ unicitate
- CreeazÄƒ automat index pentru performanÈ›Äƒ
- Previne NULL values

**UNIQUE Constraint:**
```sql
Unique(title)
```
- Previne posturi duplicate cu acelaÈ™i titlu
- Enforced la nivel de database (nu doar aplicaÈ›ie)
- CreeazÄƒ index implicit pentru performanÈ›Äƒ lookup

âš ï¸ **Case Sensitivity**: PostgreSQL UNIQUE constraint este case-sensitive
```sql
-- Acestea sunt considerate diferite:
'First Post'
'first post'
'FIRST POST'
```

**NOT NULL Constraints:**
```sql
created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
likes INTEGER NOT NULL DEFAULT 0
```
- GaranteazÄƒ cÄƒ aceste coloane au mereu valoare
- `DEFAULT` eliminÄƒ necesitatea de a specifica valoarea la INSERT

**DEFAULT Values:**
```sql
created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP  -- Timestamp automat
likes INTEGER NOT NULL DEFAULT 0                      -- Likes iniÈ›ial 0
```

#### 5. Schema Versioning - `v1_iam_service`

**De ce schema separatÄƒ?**
```properties
spring.jpa.properties.hibernate.default_schema=v1_iam_service
spring.flyway.schemas=v1_iam_service
```

**Avantaje:**
- âœ… **Versioning** - permite schema v2, v3 Ã®n viitor
- âœ… **Multi-tenancy** - multiple schemas Ã®n acelaÈ™i database
- âœ… **Namespace isolation** - evitÄƒ conflicte cu alte aplicaÈ›ii
- âœ… **Migration safety** - poÈ›i rula versiuni paralele pentru testing

**Structura Ã®n PostgreSQL:**
```
Database: post_hub_local
  â””â”€â”€ Schema: v1_iam_service
       â””â”€â”€ Table: posts
       â””â”€â”€ Table: flyway_schema_history
```

#### 6. Hibernate DDL Auto - `update`

```properties
spring.jpa.hibernate.ddl-auto=update
```

**OpÈ›iuni disponibile:**
| Valoare | Comportament | Use Case |
|---------|--------------|----------|
| `none` | Nu face nimic | Production (Flyway controleazÄƒ schema) |
| `validate` | VerificÄƒ schema vs entities | Production (safety check) |
| `update` | AdaugÄƒ coloane/tabele noi | Development |
| `create` | Drop + recreate la fiecare start | Testing |
| `create-drop` | Create la start, drop la stop | Integration tests |

**De ce `update` aici:**
- Permite experimentare Ã®n development
- SincronizeazÄƒ automat entitÄƒÈ›ile JPA cu schema
- âš ï¸ **NU** ar trebui folosit Ã®n production (Flyway ar trebui sÄƒ gestioneze schema)

**Best Practice Production:**
```properties
spring.jpa.hibernate.ddl-auto=validate  # VerificÄƒ doar, nu modificÄƒ
```

### Seed Data Strategy

**INSERT cu multiple VALUES:**
```sql
INSERT INTO posts(title, content, created, likes) VALUES
(
    'First post',
    'This is the first post',
    CURRENT_TIMESTAMP,
    9
),
(
    'Second post',
    'This is the second post',
    CURRENT_TIMESTAMP,
    20
);
```

**Avantaje acest approach:**
- âœ… Atomic - toate INSERTs reuÈ™esc sau fail Ã®mpreunÄƒ
- âœ… PerformanÈ›Äƒ - un singur query vs multiple INSERTs
- âœ… Transaction safety

**Date seeded:**
1. **First post** - 9 likes (pentru testare sorting/filtering)
2. **Second post** - 20 likes (mai popular)

## ğŸ—„ï¸ Database Changes

### StructurÄƒ CompletÄƒ PostgreSQL

**Database**: `post_hub_local`
**Schema**: `v1_iam_service`

**Table: posts**
```sql
                                Table "v1_iam_service.posts"
 Column  |            Type             | Nullable |              Default
---------+-----------------------------+----------+-----------------------------------
 id      | bigint                      | not null | nextval('posts_id_seq'::regclass)
 title   | character varying(255)      |          |
 content | text                        |          |
 created | timestamp without time zone | not null | CURRENT_TIMESTAMP
 likes   | integer                     | not null | 0

Indexes:
    "posts_pkey" PRIMARY KEY, btree (id)
    "posts_title_key" UNIQUE CONSTRAINT, btree (title)
```

**Table: flyway_schema_history** (creat automat de Flyway)
```sql
 installed_rank | version | description | type | script       | checksum    | installed_by | installed_on        | execution_time | success
----------------+---------+-------------+------+--------------+-------------+--------------+---------------------+----------------+---------
              1 | 1       | init        | SQL  | V1__init.sql | -1234567890 | postgres     | 2025-10-01 22:23:15 |             45 | t
```

## ğŸ”— RelaÈ›ii cu Alte Branch-uri

### Predecesor
**4-15-postgresql** - introducea PostgreSQL È™i Flyway dependencies, dar **NU** avea migrÄƒri sau schema

### DiferenÈ›e faÈ›Äƒ de 4-15:
| Aspect | 4-15-postgresql | 4-17-SQL |
|--------|-----------------|----------|
| **PostgreSQL config** | âœ… Da | âœ… ÃmbunÄƒtÄƒÈ›it |
| **Flyway enabled** | âœ… Da | âœ… Configurat complet |
| **Migrations** | âŒ FiÈ™ier gol | âœ… Prima migrare V1__init.sql |
| **Schema** | âŒ Nu existÄƒ | âœ… Table `posts` creatÄƒ |
| **Seed data** | âŒ Nu | âœ… 2 posturi de test |
| **H2 dependency** | âš ï¸ ÃncÄƒ prezent | âœ… Eliminat complet |

### Succesor Direct
**4-18-Entity** - creeazÄƒ entitatea JPA `Post` care mapeazÄƒ la tabelul `posts`

### Impact pe Branch-uri Viitoare
- âœ… **FundaÈ›ia pentru persistenÈ›Äƒ** - toate branch-urile viitoare vor folosi PostgreSQL
- âœ… **Pattern pentru migrÄƒri** - stabileÈ™te naming È™i organizare Flyway
- âœ… **Schema de bazÄƒ** - tabelul `posts` va fi extins Ã®n branch-uri viitoare

## ğŸ“ Commit History

```
b56d38a - configure PostgreSQL datasource and Flyway for local environment (1 Oct 2025)
â”œâ”€â”€ .idea/data_source_mapping.xml (deleted - recreated later)
â””â”€â”€ application-local-idea.properties (major updates)
    â”œâ”€â”€ PostgreSQL connection config
    â”œâ”€â”€ JPA/Hibernate settings
    â””â”€â”€ Flyway configuration

8c879c8 - replace H2 with PostgreSQL, configure initial migration and IntelliJ database settings (1 Oct 2025)
â”œâ”€â”€ .idea/data_source_mapping.xml (new)
â”œâ”€â”€ .idea/sqldialects.xml (new)
â”œâ”€â”€ pom.xml (H2 dependency removed)
â””â”€â”€ V1__init.sql (prima migrare)
    â”œâ”€â”€ CREATE TABLE posts
    â””â”€â”€ INSERT seed data

4077ebe - Merge pull request #5 from alexandru997/4-17-SQL
```

## ğŸ’¡ ÃnvÄƒÈ›Äƒminte È™i Best Practices

### âœ… Ce a fost bine implementat:

1. **Eliminarea completÄƒ H2** â­
   - Nu mai existÄƒ dual-database confusion
   - Environment consistent cu production

2. **Prima migrare Flyway** â­
   - StructurÄƒ corectÄƒ: `V1__init.sql`
   - Include atÃ¢t DDL (CREATE) cÃ¢t È™i DML (INSERT)
   - Idempotent È™i versioned

3. **Schema naming** â­
   - `v1_iam_service` permite versioning
   - Namespace isolation

4. **PostgreSQL-specific types** â­
   - BIGSERIAL pentru future-proofing
   - TEXT pentru content nelimitat
   - TIMESTAMP cu DEFAULT

5. **Constraints la nivel DB** â­
   - UNIQUE pentru title
   - NOT NULL pentru date critice
   - PRIMARY KEY

6. **Seed data** â­
   - Permite testare imediatÄƒ
   - Date realiste (titluri, likes diferite)

7. **IntelliJ integration** â­
   - SQL dialect mapping
   - Database tool window support

### âš ï¸ Zone de ÃmbunÄƒtÄƒÈ›ire:

1. **TIMESTAMP vs TIMESTAMPTZ**
   - Ar trebui `TIMESTAMPTZ` pentru timezone support
   - Important pentru aplicaÈ›ii multi-region

2. **Case-sensitive UNIQUE**
   - `Unique(title)` permite "Post" È™i "post" ca duplicate
   - Ar trebui considerat `LOWER(title)` unique index sau constraint check

3. **LipsÄƒ index pe `created`**
   - DacÄƒ se face sorting/filtering pe `created`, ar beneficia de index
   ```sql
   CREATE INDEX idx_posts_created ON posts(created DESC);
   ```

4. **VARCHAR(255) arbitrary**
   - De ce exact 255? Ar trebui bazat pe cerinÈ›e business
   - ConsiderÄƒ limitÄƒ mai micÄƒ (100-150) pentru titluri

5. **LipsÄƒ audit columns**
   - Nu existÄƒ `updated_at` column
   - Nu existÄƒ `created_by`, `updated_by` pentru tracking

6. **Integer pentru likes**
   - Ar putea avea overflow (max 2.1B)
   - BIGINT ar fi mai safe pentru aplicaÈ›ii virale

### ğŸ“š Concepte Demonstrate:

#### Database Management:
- âœ… **Flyway Migrations** - versioned database changes
- âœ… **PostgreSQL** - production-grade RDBMS
- âœ… **Schema Management** - namespace isolation
- âœ… **Seed Data** - database initialization

#### SQL Concepts:
- âœ… **DDL** - CREATE TABLE statements
- âœ… **DML** - INSERT statements
- âœ… **Constraints** - PRIMARY KEY, UNIQUE, NOT NULL
- âœ… **Sequences** - BIGSERIAL auto-increment
- âœ… **Data Types** - VARCHAR, TEXT, TIMESTAMP, INTEGER

#### Spring Boot Configuration:
- âœ… **DataSource configuration** - PostgreSQL connection
- âœ… **JPA properties** - Hibernate dialect È™i schema
- âœ… **Flyway integration** - migration management

## ğŸ“ Scop EducaÈ›ional

Acest branch este **tutorial complet pentru database setup** Ã®n Spring Boot:

### 1. Migrarea de la In-Memory la Persistent Database
DemonstreazÄƒ tranziÈ›ia de la:
- H2 in-memory (date temporare)
- PostgreSQL persistent (date permanente)

### 2. Flyway Migrations
ÃnvaÈ›Äƒ:
- Cum se structureazÄƒ migrÄƒrile
- Naming conventions
- DDL + DML Ã®n aceeaÈ™i migrare
- Version control pentru database

### 3. PostgreSQL Best Practices
DemonstreazÄƒ:
- Alegerea tipurilor de date corecte
- Constraints pentru data integrity
- Seed data pentru development

### 4. Spring Boot Database Configuration
AratÄƒ cum se configureazÄƒ:
- DataSource properties
- JPA/Hibernate settings
- Flyway integration
- Logging pentru debugging

**Target audience**:
- Beginneri care Ã®nvaÈ›Äƒ despre database persistence
- Developeri care trec de la in-memory la production databases
- Oricine vrea sÄƒ Ã®nÈ›eleagÄƒ Flyway migrations

## ğŸ”„ ComparaÈ›ie: Ãnainte vs DupÄƒ

| Aspect | Ãnainte (Branch 3-13) | DupÄƒ (Branch 4-17) |
|--------|----------------------|-------------------|
| **Database** | H2 in-memory | PostgreSQL persistent |
| **Persistence** | âŒ PierdutÄƒ la restart | âœ… PermanentÄƒ |
| **Schema** | âŒ Nu existÄƒ | âœ… Table `posts` |
| **Migrations** | âŒ Nu | âœ… Flyway V1__init.sql |
| **Seed Data** | âŒ Nu | âœ… 2 posts |
| **Production-ready** | âŒ Nu | âœ… Da (pentru DB layer) |

## ğŸ’¼ AplicaÈ›ii Practice

Acest pattern se foloseÈ™te Ã®n:

### 1. Orice AplicaÈ›ie Enterprise
```
Development:  PostgreSQL local
Staging:      PostgreSQL (managed)
Production:   PostgreSQL (managed, replicated)
```

### 2. Database Version Control
```
V1__init.sql              â†’ Initial schema
V2__add_users.sql         â†’ Add users table
V3__add_comments.sql      â†’ Add comments table
V4__alter_posts.sql       â†’ Modify posts table
```

### 3. Team Collaboration
- Developerii nu mai trebuie sÄƒ sincronizeze schema manual
- Flyway aplicÄƒ automat migrÄƒrile la startup
- Git merge conflicts Ã®n migrations sunt uÈ™or de rezolvat

### 4. CI/CD Pipelines
```bash
# Ãn pipeline:
1. Checkout code
2. Run Flyway migrate (aplicÄƒ migrÄƒri)
3. Run tests
4. Deploy application
```

**Concluzie**: Branch 4-17-SQL este **piatra de temelie** pentru persistenÈ›a datelor Ã®n aplicaÈ›ie. Toate feature-urile viitoare se bazeazÄƒ pe aceastÄƒ fundaÈ›ie.
